rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: is signed-in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: same user (by field on the document)
    function isOwner(userIdField) {
      return isSignedIn() && resource.data[userIdField] == request.auth.uid;
    }

    // USERS: own profile
    match /users/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      // no delete from client by default
    }

    // HOSTS: host metadata / subscription / points
    match /hosts/{hostId} {
      allow read: if isSignedIn() && request.auth.uid == hostId;
      allow create, update: if isSignedIn() && request.auth.uid == hostId;
    }

    // LISTINGS: public read, hosts manage their own
    match /listings/{listingId} {
      // Anyone can read published listings
      allow read: if resource.data.status == 'published'
                  || (isSignedIn() && resource.data.hostId == request.auth.uid);

      // Host creates listing for themselves
      allow create: if isSignedIn()
                    && request.resource.data.hostId == request.auth.uid;

      // Host updates their own listing
      allow update, delete: if isSignedIn()
                            && resource.data.hostId == request.auth.uid;
    }

    // BOOKINGS: guests create, host/guest read, basic update
    match /bookings/{bookingId} {
      // Read if you are the guest or the host
      allow read: if isSignedIn()
                  && (resource.data.guestId == request.auth.uid
                      || resource.data.hostId == request.auth.uid);

      // Guest creates booking for themselves
      allow create: if isSignedIn()
                    && request.resource.data.guestId == request.auth.uid;

      // Allow status updates by host or guest (e.g., accepted/declined/refundRequested)
      allow update: if isSignedIn()
                    && (resource.data.guestId == request.auth.uid
                        || resource.data.hostId == request.auth.uid);
    }

    // REFUNDS: guest creates, host/admin reads/updates
    match /refunds/{refundId} {
      // Read if you are the guest or host involved
      allow read: if isSignedIn()
                  && (resource.data.guestId == request.auth.uid
                      || resource.data.hostId == request.auth.uid);

      // Guest creates refund request
      allow create: if isSignedIn()
                    && request.resource.data.guestId == request.auth.uid;

      // Host can update status (e.g., approved/denied)
      allow update: if isSignedIn()
                    && resource.data.hostId == request.auth.uid;
    }

    // MESSAGES: chat between guest and host
    match /messages/{messageId} {
      // Read if you are the guest or host in the conversation
      allow read: if isSignedIn()
                  && (resource.data.guestId == request.auth.uid
                      || resource.data.hostId == request.auth.uid);

      // Create if you are the sender and either guestId or hostId equals you
      allow create: if isSignedIn()
                    && (
                      request.resource.data.senderId == request.auth.uid
                      && (
                        request.resource.data.guestId == request.auth.uid
                        || request.resource.data.hostId == request.auth.uid
                      )
                    );
    }

    // WISHLIST PREFERENCES
    match /wishlistPreferences/{userId} {
      allow read, create, update: if isSignedIn() && request.auth.uid == userId;
    }

    // FAVORITES (guest wishlist)
    match /favorites/{favoriteId} {
      // User can read their own favorites
      allow read: if isSignedIn()
                  && resource.data.userId == request.auth.uid;

      // User can create their own favorite
      allow create: if isSignedIn()
                    && request.resource.data.userId == request.auth.uid;

      // User can delete their own favorite
      allow delete: if isSignedIn()
                    && resource.data.userId == request.auth.uid;

      // No updates
      allow update: if false;
    }

    // REVIEWS: guests leave reviews on listings
    match /reviews/{reviewId} {
      allow read: if true;

      allow create: if isSignedIn()
                    && request.resource.data.guestId == request.auth.uid;

      // Optional: allow guest to update/delete own review
      allow update, delete: if isSignedIn()
                            && resource.data.guestId == request.auth.uid;
    }

    // WALLETS & WALLET TRANSACTIONS
    match /wallets/{userId} {
      allow read, create, update: if isSignedIn() && request.auth.uid == userId;
    }

    match /walletTransactions/{txId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    // COUPONS: hosts manage their coupons, guests read active ones
    match /coupons/{couponId} {
      // Anyone signed-in can read ACTIVE coupons,
      // Host can read all of their own coupons (active or not).
      allow get, list: if isActiveCoupon() || isHostOwner();

      // Host creates coupon for themselves
      allow create: if isSignedIn()
                    && request.resource.data.hostId == request.auth.uid;

      // Host updates or deletes their own coupon
      allow update, delete: if isHostOwner();

      function isHostOwner() {
        return isSignedIn() && resource.data.hostId == request.auth.uid;
      }

      function isActiveCoupon() {
        return resource.data.active == true;
      }
    }

    // HOST FEE DISCOUNTS (points reward: fee discount)
    match /hostFeeDiscounts/{docId} {
      // Host can read their own discounts
      allow read: if isSignedIn()
                  && resource.data.hostId == request.auth.uid;

      // Host creates discounts when redeeming points
      allow create: if isSignedIn()
                    && request.resource.data.hostId == request.auth.uid;
      // No client updates/deletes for now
    }

    // HOST FREE LISTINGS (points reward: free listing credits)
    match /hostFreeListings/{docId} {
      // Host can read their own free listing credits
      allow read: if isSignedIn()
                  && resource.data.hostId == request.auth.uid;

      // Host creates credits when redeeming points
      allow create: if isSignedIn()
                    && request.resource.data.hostId == request.auth.uid;

      // HostListings.jsx decrements remainingListings when a credit is consumed
      allow update: if isSignedIn()
                    && resource.data.hostId == request.auth.uid;
    }

    // HOST PROMOTIONS (points reward: promotions/boosts)
    match /hostPromotions/{promoId} {
      // Host can read their own promotions
      allow read: if isSignedIn()
                  && resource.data.hostId == request.auth.uid;

      // Host creates promotions when redeeming points
      allow create: if isSignedIn()
                    && request.resource.data.hostId == request.auth.uid;
    }

    // HOST EARNINGS (updated when bookings are accepted)
    match /hostEarnings/{hostId} {
      // Host can see their own earnings
      allow read: if isSignedIn() && request.auth.uid == hostId;

      // HostBookings.jsx writes/updates this from the client
      allow create, update: if isSignedIn() && request.auth.uid == hostId;
    }

    // HOST POINTS EVENTS (log of how points were earned)
    match /hostPointsEvents/{eventId} {
      // Host can read their own events
      allow read: if isSignedIn()
                  && resource.data.hostId == request.auth.uid;

      // Logged when signup bonus or booking points are awarded
      allow create: if isSignedIn()
                    && request.resource.data.hostId == request.auth.uid;
    }
  }
}